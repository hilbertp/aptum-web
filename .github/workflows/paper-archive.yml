name: Build paper archive

on:
  workflow_dispatch:
  # schedule removed for now to keep noise low; can re-enable later

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      REPO: github.com/hilbertp/aptum-web
      GIT_AUTHOR_NAME: II-Agent
      GIT_AUTHOR_EMAIL: bot+ii-agent@users.noreply.github.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pdfminer.six

      - name: Fetch free-licensed papers
        run: |
          python scripts/fetch_papers.py

      - name: Sanity check required paths
        run: |
          test -f scripts/fetch_papers.py
          test -f public/papers/index.json
          test -f docs/papers/README.md
          test -f docs/papers/AUDIT.json || echo '{ }' > docs/papers/AUDIT.json

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(papers): update free-licensed papers archive, index and audit"
          title: "feat: update free-licensed papers archive"
          body: |
            This PR updates the free-licensed paper archive.
            - Downloads CC BY/CC0/CC BY-SA PDFs where possible
            - Regenerates metadata index and README table
            - Produces a license audit (docs/papers/AUDIT.json)

            Notes: Some CC BY publishers (e.g., MDPI) block automated downloads. These are linked externally and marked in the audit.
          branch: feat/papers-archive
          delete-branch: true
