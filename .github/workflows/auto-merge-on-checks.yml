name: Auto-merge when checks pass

on:
  check_suite:
    types: [completed]
  check_run:
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App installation token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GHA_APP_ID }}
          private_key: ${{ secrets.GHA_APP_PRIVATE_KEY }}

      - name: Attempt enable auto-merge on open PRs for branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const branch = context.payload.check_suite?.head_branch || context.payload.check_run?.check_suite?.head_branch || context.payload.check_run?.head_branch;
            if (!branch) { core.info('No branch found'); return; }
            const { data: prs } = await github.rest.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open', head: `${context.repo.owner}:${branch}` });
            for (const pr of prs) {
              try {
                await github.graphql(`mutation($pr:ID!){ enablePullRequestAutoMerge(input:{pullRequestId:$pr, mergeMethod:SQUASH}){ clientMutationId } }`, { pr: pr.node_id });
                core.info(`Auto-merge enabled on PR #${pr.number}`);
              } catch (e) {
                core.info(`Could not enable for PR #${pr.number}: ${String(e)}`);
              }
            }
